<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="../api.js"></script>

</head>
<body>
<style>
    table {
        border-collapse: collapse;
        width: 100%;
    }

    td, th {
        border: 1px solid #262626;
        text-align: left;
        padding: 8px;
    }
</style>
    <div class="container">
        <a href="../index.html">กลับ</a>
        <h2>สร้างบิล</h2>
        <div class="row">
            <div class="col-md-3">
                <label>รหัสบิล</label><br>
                <input type="text" id="code" value="BILLXXXXXXX" disabled>
            </div>
        </div>
        <label>วันที่</label><br>
        <input type="date" id="date" style="width:195px;" disabled>
        <button style="float: right;" onclick="add_table()">เพิ่ม</button>
        <br><br>
        <table id="table">
            <thead>
                <tr>
                    <th width="5%">No.</th>
                    <th width="15%">รหัสสินค้า</th>
                    <th width="15%">ชื่อสินค้า</th>
                    <th width="5%">หน่วย</th>
                    <th width="5%">จำนวน</th>
                    <th width="15%">ราคา</th>
                    <th width="10%">ส่วนลด (%)</th>
                    <th width="10%">ส่วนลด (บาท)</th>
                    <th width="20%">รวมเงิน</th>
                    <th width="5%">ลบ</th>

                </tr>
            </thead>
            <tbody id="tbody">


            </tbody>
        </table>
        <br><br>
        <div style="float: right;">
            <div class="row">
                <div class="col-md-6">
                    <label>ยอดรวมสินค้า</label> 
                    <input type="text" id="product_price" disabled>  
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <label>ยอดรวมส่วนลดสินค้า</label> 
                    <input type="text" id="product_discount" disabled>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <label>ส่วนลดท้ายบิล</label> 
                    <input type="number" id="last_discount" onchange="CalculateTotalPrice()">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <label>ราคารวมสุทธิ</label> 
                    <input type="text" id="total_price" disabled>
                </div>
            </div>
            <br>
            <button onclick="Insert()">บันทึก</button>
            <br><br><br>
        </div>
        <br><br><br><br><br><br><br><br>
    </div>
    <br><br>
    <template id="receipt_template">
        <td class="num"></td>
        <td><select class="item"></select></td>
        <td class="name"></td>
        <td class="unit"></td>
        <td><input type="number" class="qty"></td>
        <td class="price"></td>
        <td><input type="number" class="discount"></td>
        <td><input type="number" class="discount_bath" disabled></td>
        <td class="total"></td>
        <td><button class="delete">ลบ</button></td>
    </template>
    <script>
        let data_item; // data item[]
        let x=1;

        ( async function() 
        {
            document.getElementById('date').valueAsDate = new Date();;
            data_item = await GetAllItem()
        })();
        
        function add_table(){
            const table = document.querySelector("#table tbody")
            const template = document.getElementById("receipt_template");
            const tr = document.createElement("tr")
            const template_clone = template.content.cloneNode(true);
            tr.appendChild(template_clone);
            table.appendChild(tr);
            SetTable()
        }
        
        // delete table
        function SetTable(){
            const table = document.querySelector("#table tbody")
            const template = document.getElementById("receipt_template");
            const data = document.querySelectorAll('#table tbody tr')
            table.innerHTML = ''
            data.forEach((row, index) => {
                const tr = document.createElement("tr")
                const template_clone = template.content.cloneNode(true);
                template_clone.querySelector('.num').innerText = index+1
                const select = template_clone.querySelector(".item")
                let option = document.createElement("option");
                select.appendChild(option);
                for (i = 0; i < data_item.length; i++) {
                    option = document.createElement("option");
                    option.setAttribute("value", data_item[i]['item_id']);
                    option.text = data_item[i]['item_code'];
                    select.appendChild(option);
                }
                const name = template_clone.querySelector('.name')
                const unit = template_clone.querySelector('.unit')
                const qty = template_clone.querySelector(".qty")
                const price = template_clone.querySelector('.price')
                const discount = template_clone.querySelector(".discount")
                const discount_bath = template_clone.querySelector('.discount_bath')
                const total = template_clone.querySelector('.total')

                name.innerText = row.querySelector('.name').innerText
                unit.innerText = row.querySelector('.unit').innerText
                select.value = row.querySelector('.item').value
                qty.value = row.querySelector('.qty').value
                price.innerText = row.querySelector('.price').innerText
                discount.value = row.querySelector('.discount').value
                discount_bath.value = row.querySelector('.discount_bath').value
                total.innerText = row.querySelector('.total').innerText

                select.addEventListener('change', function(){ 
                    for (i = 0; i < data_item.length; i++) {
                        if(data_item[i]['item_id'] == select.value){
                            unit.innerText = data_item[i]['item_unit']['unit_name']
                            name.innerText = data_item[i]['item_name']
                            price.innerText = data_item[i]['item_price'].toFixed(2)
                        }
                    }
                    discount_bath.value = CalculateDiscount(qty.value, price.innerText, discount.value)
                    const cal = (qty.value * price.innerText) - discount_bath.value;
                    if(cal < 0){
                        total.innerText = '0.00';
                    }else{
                        total.innerText = cal.toFixed(2);
                    }
                    CalculateProductPrice();
                    CalculateProductDiscount();
                    CalculateTotalPrice();
                })

                qty.addEventListener('change', function(){ 
                    discount_bath.value = CalculateDiscount(qty.value, price.innerText, discount.value)
                    const cal = (qty.value * price.innerText) - discount_bath.value;
                    if(cal < 0){
                        total.innerText = '0.00';
                    }else{
                        total.innerText = cal.toFixed(2);
                    }
                    CalculateProductPrice();
                    CalculateProductDiscount();
                    CalculateTotalPrice();
                })

                discount.addEventListener('change', function(){ 
                    discount_bath.value = CalculateDiscount(qty.value, price.innerText, discount.value)
                    const cal = (qty.value * price.innerText) - discount_bath.value;
                    if(cal < 0){
                        total.innerText = '0.00';
                    }else{
                        total.innerText = cal.toFixed(2);
                    }
                    CalculateProductPrice();
                    CalculateProductDiscount();
                    CalculateTotalPrice();
                })

                template_clone.querySelector('.delete').addEventListener('click', function(){ 
                    this.parentNode.parentNode.remove();
                    SetTable()
                })

                tr.appendChild(template_clone);
                table.appendChild(tr);
            })
        }

        function CalculateDiscount(qty, price, discount){
            let total = (qty * price)
            let discount_bath = (total * discount)/100
            if(discount_bath > total){
                discount_bath = total;
            }
            return discount_bath.toFixed(2);
        }

        function CalculateProductPrice(){
            let array_total = document.getElementsByClassName("total");
            let total = 0;
            for(i=0; i<array_total.length;i++){
                total += Number(array_total[i].innerHTML)
            }
            document.getElementById("product_price").value = total.toFixed(2);
        }

        function CalculateProductDiscount()
        {
            let array_discount = document.getElementsByClassName("discount_bath");
            let total = 0;
            for(i=0; i<array_discount.length;i++){
                total += Number(array_discount[i].value)
            }
            document.getElementById("product_discount").value = total.toFixed(2);
        }

        function CalculateTotalPrice()
        {
            let total = document.getElementById("product_price").value;
            let last_discount = document.getElementById("last_discount").value;
            let total_price = total - last_discount;
            if(total_price < 0){
                document.getElementById("total_price").value = '0.00';
            }else{
                document.getElementById("total_price").value = total_price.toFixed(2);
            }
        }

        async function Insert(){

            let select = document.getElementsByClassName("item");
            let qty = document.getElementsByClassName("qty");
            let price = document.getElementsByClassName("price");
            let discount = document.getElementsByClassName("discount");
            let discount_bath = document.getElementsByClassName("discount_bath");
            let total = document.getElementsByClassName("total");
            const list = [];
    
            for(i=0;i<select.length;i++){
                if(select[i].value != ''){

                    list.push({
                        list_item_id : select[i].value,
                        list_quantity : qty[i].value == ''? 0: qty[i].value,
                        list_price : price[i].innerText,
                        list_discount : discount[i].value == ''? 0: discount[i].value,
                        list_discount_bath : discount_bath[i].value,
                        list_total_price : total[i].innerText
                    })
                }
            }        
            let receipt_product_price = document.getElementById('product_price').value;
            let receipt_product_discount = document.getElementById('product_discount').value;
            let receipt_discount = document.getElementById('last_discount').value;
            let receipt_total_price = document.getElementById('total_price').value;
            if(receipt_discount == ''){
                receipt_discount = 0;
            }
            const result = await InsertReceipt(receipt_product_price, receipt_product_discount, receipt_discount, receipt_total_price, list)

            if(result.status_code == -1){
                alert(result.message);
            }else{
                alert(result.message);
                location.reload();
            }
        }

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    </body>
</html>

