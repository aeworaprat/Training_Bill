<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
<style>
    table {
        border-collapse: collapse;
        width: 100%;
    }

    td, th {
        border: 1px solid #262626;
        text-align: left;
        padding: 8px;
    }
</style>
    <div class="container">
        <a href="../index.html">กลับ</a>
        <h2>จัดการสินค้า</h2>
        <button style="float: right;" data-toggle="modal" data-target="#add" onclick='OpenModal()'>เพิ่ม</button>
        <br><br>
        <div id="create_table">

        </div>
    </div>
    <div class="modal fade" id="add" tabindex="-1" aria-labelledby="exampleModalLabel" aria-modal="true" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">เพิ่มสินค้า</h5>
                    <button type="button" class="close" aria-label="Close"  onclick="CloseModal()">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label>รหัสสินค้า</label><br>
                            <input type="text" id="item_code" value="ITEMXXXXXX" disabled>
                        </div>
                        <div class="col-md-6">
                            <label>ชื่อสินค้า</label><br>
                            <input type="text" id="item_name" autocomplete="off">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label>ราคา</label><br>
                            <input type="number" id="item_price" autocomplete="off">
                        </div>
                        <div class="col-md-6">
                            <label>หน่วย</label><br>
                            <div id="myDiv">

                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="CloseModal()">ยกเลิก</button>
                    <button type="button" onclick="InsertItem()">บันทึก</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="update" tabindex="-1" aria-labelledby="exampleModalLabel" aria-modal="true" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">แก้ไขหน่วย</h5>
                    <button type="button" class="close" aria-label="Close"  onclick="CloseModalEdit()">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="item_id">
                    <div class="row">
                        <div class="col-md-6">
                            <label>รหัสสินค้า</label><br>
                            <input type="text" id="item_code_edit" disabled>
                        </div>
                        <div class="col-md-6">
                            <label>ชื่อสินค้า</label><br>
                            <input type="text" id="item_name_edit" autocomplete="off">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label>ราคา</label><br>
                            <input type="number" id="item_price_edit" autocomplete="off">
                        </div>
                        <div class="col-md-6">
                            <label>หน่วย</label><br>
                            <div id="myDiv_edit">

                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="CloseModalEdit()">ยกเลิก</button>
                    <button type="button" onclick="UpdateItem()">บันทึก</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show" id="backdrop"  style="display: none;"></div>
    <script>
    
    (function() 
    {
        GetAllItem();
        GetUnit();
    })();

    async function GetAllItem()
    {
        const result = await axios.get('http://localhost:5252/Item/GetAll',);
        const data = result.data;
        CreateTable(data);
    }

    let data_unit
    async function GetUnit()
    {
        const result = await axios.get('http://localhost:5252/Unit/GetAll',);
        const data = result.data;
        data_unit = data;
    }

    function CreateTable(data)
    {
        let html_code = "";
        html_code += "<table>";
        html_code += "<tr>";
        html_code += "<th width='5%'>No.</th>";
        html_code += "<th width='15%'>รหัสสินค้า</th>";        
        html_code += "<th>ชื่อสินค้า</th>";
        html_code += "<th width='10%'>หน่วย</th>";
        html_code += "<th style='text-align:right'>ราคา</th>";
        html_code += "<th width='20%' style='text-align:center'>ดำเนินการ</th>";
        html_code += "</tr>";
        data.forEach((row, index) => {
            html_code += "<tr>";
            html_code += "<td>"+(index+1)+"</td>";
            html_code += "<td>"+row['item_code']+"</td>";
            html_code += "<td>"+row['item_name']+"</td>";
            html_code += "<td>"+row['unit_name']+"</td>";
            html_code += "<td style='text-align:right'>"+row['item_price']+"</td>";
            html_code += "<td style='text-align:center'>";
            html_code += "<button onclick='OpenModalEdit("+`${row['item_id']}, "${row['item_code']}", "${row['item_name']}", ${row['item_price']}, ${row['item_unit_id']}`+")'>แก้ไข</button> ";
            html_code += "<button onclick='DeleteItem("+`${row['item_id']}, "${row['item_code']}", "${row['item_name']}"`+")'>ลบ</button>";
            html_code += "</td>";
            html_code += "</td>";
            html_code += "</tr>";
        })
        html_code += "<table>";
        document.getElementById("create_table").innerHTML = html_code;
    }

    async function InsertItem()
    {
        let name = document.getElementById("item_name").value.trim();
        let price = document.getElementById("item_price").value;
        let unit_id = document.getElementById("unit").value;

        let select = document.getElementById("unit");
        let unit_name = select.options[select.selectedIndex].text;

        let check = 0;

        if(name == ''){
            check = 1;
        }else if(price == ''){
            check = 1;
        }else if(unit_id == ''){
            check = 1;
        }

        if(check == 1){
            alert('no value');
        }else{
            await axios.post('http://localhost:5252/Item/InsertItem', { 
                item_name : name,
                item_price : Number(price),
                item_code : "test",
                item_unit_id : Number(unit_id)
            }).then(function (response) {
                let result = response.data;
                if(result == false){
                    alert('บันทึกไม่สำเร็จ');
                }else{
                    GetAllItem();
                    alert('บันทึกสำเร็จ');
                    CloseModal();
                }
            })
        }
    }

    async function UpdateItem(){
        let item_id = document.getElementById("item_id").value;
        let item_code = document.getElementById("item_code_edit").value;
        let name = document.getElementById("item_name_edit").value.trim();
        let price = document.getElementById("item_price_edit").value;
        let unit_id = document.getElementById("unit_edit").value;
        const check = 0;

        if(name == ''){
            check = 1;
        }else if(price == ''){
            check = 1;
        }
        
        if(check == 1){
            alert('no value');
        }else{
            await axios.post('http://localhost:5252/Item/UpdateItem', { 
                item_id : item_id,
                item_name : name,
                item_code : item_code,
                item_price : Number(price),
                item_unit_id : Number(unit_id)
            }).then(function (response) {
                let result = response.data;
                if(result == false){
                    alert('อัพเดตไม่สำเร็จ');
                }else{
                    GetAllItem();
                    alert('อัพเดตสำเร็จ');
                    CloseModalEdit();
                }
            })
        }
    }

    async function DeleteItem(id, code, name)
    {
        await axios.post('http://localhost:5252/Item/DeleteItem', {
            item_id : id,
            item_code : code,
            item_name : name
        }).then(function (response) {
            let result = response.data;
            if(result == false){
                alert('ลบไม่สำเร็จ');
            }else{
                GetAllItem();
                alert('ลบสำเร็จ');
            }
        })
    }


    // modal add
    function OpenModal() 
    {
        document.getElementById("backdrop").style.display = "block"
        document.getElementById("add").style.display = "block"
        document.getElementById("add").classList.add("show")

        let myDiv = document.getElementById("myDiv");
        
        let selectList = document.createElement("select");
        selectList.setAttribute("id", "unit");
        myDiv.appendChild(selectList);

        let option = document.createElement("option");
        selectList.appendChild(option);

        for (i = 0; i < data_unit.length; i++) {
            option = document.createElement("option");
            option.setAttribute("value", data_unit[i]['unit_id']);
            option.text = data_unit[i]['unit_name'];
            selectList.appendChild(option);
        }
    }

    function CloseModal() 
    {
        document.getElementById("backdrop").style.display = "none"
        document.getElementById("add").style.display = "none"
        document.getElementById("add").classList.remove("show")

        let selectobject = document.getElementById("unit");
        selectobject.remove();
    }

    let modal = document.getElementById('add');

    window.onclick = function(event) 
    {
        if (event.target == modal) {
            closeModal()
        }
    }

    //modal edit
    function OpenModalEdit(id, code, name, price, unit_id) 
    {
        document.getElementById("item_id").value = id; // set update id
        document.getElementById("item_code_edit").value = code; // set update code
        document.getElementById("item_name_edit").value = name; // set update code
        document.getElementById("item_price_edit").value = price; // set update code

        let myDiv = document.getElementById("myDiv_edit");
        
        let selectList = document.createElement("select");
        selectList.setAttribute("id", "unit_edit");
        myDiv.appendChild(selectList);

        for (let i = 0; i < data_unit.length; i++) {
            option = document.createElement("option");
            option.setAttribute("value", data_unit[i]['unit_id']);
            option.text = data_unit[i]['unit_name'];
            selectList.appendChild(option);
            //set item_unit_id select
            if(data_unit[i]['unit_id'] == unit_id){
                let selId = document.getElementById("unit_edit");
                selId.options[i].selected = true;
            }
        }
        document.getElementById("backdrop").style.display = "block"
        document.getElementById("update").style.display = "block"
        document.getElementById("update").classList.add("show");

        //set item_unit_id select
    }
    function CloseModalEdit() 
    {
        document.getElementById("backdrop").style.display = "none"
        document.getElementById("update").style.display = "none"
        document.getElementById("update").classList.remove("show")

        let selectobject = document.getElementById("unit_edit");
        selectobject.remove();
    }

    let modalEdit = document.getElementById('update');

    window.onclick = function(event) 
    {
        if (event.target == modalEdit) {
            closeModal()
        }
    }
    </script>
    </body>
</html>