<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

</head>
<body>
<style>
    table {
        border-collapse: collapse;
        width: 100%;
    }

    td, th {
        border: 1px solid #262626;
        text-align: left;
        padding: 8px;
    }
</style>
    <div class="container">
        <a href="../index.html">กลับ</a>
        <h2>จัดการสินค้า</h2>
        <button style="float: right;" data-toggle="modal" data-target="#add" id="open_modal">เพิ่ม</button>
        <br><br>
        <table id="table">
            <thead>
                <tr>
                    <th width='5%'>No.</th>
                    <th width='15%'>รหัสสินค้า</th>
                    <th>ชื่อสินค้า</th>
                    <th width='10%'>หน่วย</th>
                    <th style='text-align:right'>ราคา</th>
                    <th width='20%' style='text-align:center'>ดำเนินการ</th>
                </tr>
            </thead>
            <tbody>                
            </tbody>
        </table>
        <template id="item_template">
            <td class="num"></td>
            <td class="code"></td>
            <td class="name"></td>
            <td class="unit"></td>
            <td class="price" style='text-align:right'></td>
            <td style='text-align:center'>
            <button class="edit">แก้ไข</button> 
            <button class="delete">ลบ</button>
        </template>
        <template id="modal_add">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">เพิ่มสินค้า</h5>
                <button type="button" class="close" aria-label="Close" id="close_modal">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <label>รหัสสินค้า</label><br>
                        <input class="item_code" disabled>
                    </div>
                    <div class="col-md-6">
                        <label>ชื่อสินค้า</label><br>
                        <input class="item_name" autocomplete="off">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <label>ราคา</label><br>
                        <input class="item_price" autocomplete="off">
                    </div>
                    <div class="col-md-6">
                        <label>หน่วย</label><br>
                        <select class="unit">
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="cancel">ยกเลิก</button>
                <button type="button" class="save">บันทึก</button>
            </div>
        </template>
    </div>
    <div class="modal fade" id="add" tabindex="-1" aria-labelledby="exampleModalLabel" aria-modal="true" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
            
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show" id="backdrop"  style="display: none;"></div>
    <script type="module">
    import { GetAllUnit ,GetAllItem, InsertItem, UpdateItem, DeleteItem  } from '../api.js'
    let data_unit;

    window.addEventListener('DOMContentLoaded', async (event) => {
        data_unit = await GetAllUnit()
        GetItem()
        document.getElementById('open_modal').addEventListener('click', function(){ OpenModal() })
    });

    async function GetItem()
    {
        const data = await GetAllItem()
        CreateTable(data);
    }


    function CreateTable(data)
    {
        const table = document.querySelector("#table tbody")
        table.innerHTML = ''
        const template = document.getElementById("item_template");

        data.forEach((row, index) => {
            const tr = document.createElement("tr")
            const template_clone = template.content.cloneNode(true);
            template_clone.querySelector('.num').innerText = index+1
            template_clone.querySelector('.code').innerText = row.item_code
            template_clone.querySelector('.name').innerText = row.item_name
            template_clone.querySelector('.unit').innerText = row.item_unit.unit_name
            template_clone.querySelector('.price').innerText = row.item_price
            template_clone.querySelector('.edit').addEventListener('click', function(){ OpenModal(row) })
            template_clone.querySelector('.delete').addEventListener('click', function(){ Delete(row.item_id, row.item_code, row.item_name) })
            tr.appendChild(template_clone);
            table.appendChild(tr);
        })
    }

    async function Insert(name, price, unit_id)
    {
        let check = 0;

        if(name == ''){
            check = 1;
        }else if(price == ''){
            check = 1;
        }else if(unit_id == ''){
            check = 1;
        }
        if(check == 1){
            alert('no value');
        }else{
            const result = await InsertItem(name, price, unit_id)
            GetItem();
            CloseModal();

            if(result.status_code == -1){
                alert(result.message);
            }else{
                alert(result.message);
            }
        }
    }

    async function Update(name, price, unit_id, item_id){
        const check = 0;

        if(name == ''){
            check = 1;
        }else if(price == ''){
            check = 1;
        }
        
        if(check == 1){
            alert('no value');
        }else{
            const result = await UpdateItem(name, price, unit_id, item_id)
            if(result.status_code == -1){
                alert(result.message);
            }else{
                GetItem();
                alert(result.message);
                CloseModal();
            }
        }
    }

    async function Delete(id, code, name)
    {
        const result = await DeleteItem(id, code, name)
        if(result.status_code == -1){
            alert(result.message);
        }else{
            GetItem();
            alert(result.message);
        }
    }


    // modal add
    function OpenModal(row) 
    {
        const add = document.getElementById("add")
        const template = document.getElementById('modal_add')
        const template_clone = template.content.cloneNode(true);
        const content = document.querySelector('.modal-content')
        content.innerHTML = ''
        const input_code = template_clone.querySelector(".item_code")
        const input_name = template_clone.querySelector(".item_name")
        const input_price = template_clone.querySelector(".item_price")
        const input_select = template_clone.querySelector(".unit")
        let option = document.createElement("option");
        input_select.appendChild(option);

        for (let i = 0; i < data_unit.length; i++) {
            option = document.createElement("option");
            option.setAttribute("value", data_unit[i]['unit_id']);
            option.text = data_unit[i]['unit_name'];
            input_select.appendChild(option);
        }
        template_clone.querySelector('.cancel').addEventListener('click', function(){ CloseModal() })

        if(row === undefined || row === null){
            template_clone.querySelector('.modal-title').innerText = 'เพิ่มสินค้า'
            input_code.value = "ITEM-xxxx"
            template_clone.querySelector('.save').addEventListener('click', function(){ 
                const name = input_name.value
                const price = input_price.value
                const select = input_select.value
                Insert(name, price, select)
                GetItem();
                CloseModal();
            })
        }else{
            template_clone.querySelector('.modal-title').innerText = 'แก้ไขสินค้า'
            input_code.value = row.item_code;
            input_name.value = row.item_name;
            input_price.value = row.item_price;
            input_select.value = row.item_unit_id;
            template_clone.querySelector('.save').addEventListener('click', function(){ 
                const name = input_name.value
                const price = input_price.value
                const select = input_select.value
                Update(name, price, select, row.item_id)
                CloseModal();
            })
        }
        content.appendChild(template_clone)
        document.getElementById("backdrop").style.display = "block"
        add.style.display = "block"
        add.classList.add("show")

        document.getElementById('close_modal').addEventListener('click', CloseModal)

    }

    function CloseModal() 
    {
        document.getElementById("backdrop").style.display = "none"
        document.getElementById("add").style.display = "none"
        document.getElementById("add").classList.remove("show")
    }
    </script>
    </body>
</html>