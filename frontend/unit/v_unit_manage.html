<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

</head>
<body>
<style>
    table {
        border-collapse: collapse;
        width: 100%;
    }

    td, th {
        border: 1px solid #262626;
        text-align: left;
        padding: 8px;
    }
</style>
    <div class="container">
        <a href="../index.html">กลับ</a>
        <h2>จัดการหน่วย</h2>
        <button type="button" style="float: right;" data-toggle="modal" data-target="#add" id="add_modal">เพิ่ม</button>
        <br><br>
        <table id="table">
            <thead>
                <tr>
                    <th width='10%'>No.</th>
                    <th>ชื่อ</th>
                    <th style='text-align:center' width='20%'>ดำเนินการ</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        <!-- tempalte unit -->
        <template id="unit_template">
            <td class="num"></td>
            <td class="name"></td>
            <td style='text-align:center'>
                <button class="edit" data-toggle="modal" data-target="#add">แก้ไข</button>
                <button class="delete" >ลบ</button>
            </td>
        </template>

        <template id="modal_add">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel"></h5>
                <button type="button" class="close" aria-label="Close"  id="close_modal">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
            <label>ชื่อหน่วย</label><br>
            <input type="text" class="unit_add" autocomplete="off">
            </div>
            <div class="modal-footer">
                <button type="button" class="cancel">ยกเลิก</button>
                <button type="button" class="save">บันทึก</button>
            </div>
        </template>
    </div>
    <div class="modal fade" id="add" tabindex="-1" aria-labelledby="exampleModalLabel" aria-modal="true" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">



            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show" id="backdrop"  style="display: none;"></div>

<script type="module">
    import { GetAllUnit, InsertUnti, DeleteUnit, UpdateUnit } from '../api.js'

    window.addEventListener('DOMContentLoaded', (event) => {
        GetUnit()
        document.getElementById('add_modal').addEventListener('click', function(){ OpenModal() });
    });
    
    

    async function GetUnit(){
        let data = [];
        data = await GetAllUnit();
        CreateTable(data)
    }

    // createtable
    function CreateTable(data)
    {
        const table = document.querySelector("#table tbody")
        table.innerHTML = ''
        const template = document.getElementById("unit_template");

        data.forEach((row, index) => {
            const tr = document.createElement("tr")
            const template_clone = template.content.cloneNode(true);
            
            template_clone.querySelector('.num').innerText = index+1
            template_clone.querySelector('.name').innerText = row.unit_name
            template_clone.querySelector('.edit').addEventListener('click', function(){ OpenModal(row) })
            template_clone.querySelector('.delete').addEventListener('click', function(){ Delete(row.unit_id, row.unit_name) })

            tr.appendChild(template_clone);
            table.appendChild(tr);
        });
    }

    // insert unit
    async function Insert(name)
    {
        name = name.trim();
        if(name == ''){
            alert('no value');
        }else{
            const result = await InsertUnti(name);
            if(result.status_code == -1){
                alert(result.message)
            }else{
                GetUnit()
                alert(result.message)
                CloseModal()
            }
        }
    }

    // delete unit
    async function Delete(id, name)
    {
        const result = await DeleteUnit(id, name)

        if(result.status_code == -1){
            alert(result.message)
        }else{
            GetUnit()
            alert(result.message)
        }
    
    }

     // update unit
    async function Update(id ,name)
    {
        name = name.trim();
        if(name == ''){
            alert('no value');
        }else{
            const result = await UpdateUnit(id ,name)
            if(result.status_code == -1){
                alert(result.message);
            }else{
                GetUnit();
                alert(result.message);
                CloseModal();
            }
        }
    }

    // modal add
    function OpenModal(row) 
    {
        const add = document.getElementById("add")
        const template = document.getElementById('modal_add')
        const template_clone = template.content.cloneNode(true);
        const content = document.querySelector('.modal-content')
        content.innerHTML = ''
        const input_name = template_clone.querySelector(".unit_add")
        template_clone.querySelector('.cancel').addEventListener('click', CloseModal)

        if(row === undefined || row === null){
            template_clone.querySelector('.modal-title').innerText = 'เพิ่มหน่วย'
            template_clone.querySelector('.save').addEventListener('click', function(){ 
                const name = input_name.value
                Insert(name)
            })
        }else{
            template_clone.querySelector('.modal-title').innerText = 'แก้ไขหน่วย'
            input_name.value = row.unit_name
            template_clone.querySelector('.save').addEventListener('click', function(){ 
                const name = input_name.value
                Update(row.unit_id, name) 
            })
        }

        content.appendChild(template_clone)
        document.getElementById("backdrop").style.display = "block"
        add.style.display = "block"
        add.classList.add("show")

        document.getElementById('close_modal').addEventListener('click', CloseModal );
    }
    
    function CloseModal() 
    {
        document.getElementById("backdrop").style.display = "none"
        document.getElementById("add").style.display = "none"
        document.getElementById("add").classList.remove("show")
    }

    </script>
    </body>
</html>